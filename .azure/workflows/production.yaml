name: Platform Production Deployment at Vercel
trigger:
  branches:
    include:
      - master

variables:
  VERCEL_PROJECT_ID: $(PROJECT_ID)
  VERCEL_ORG_ID: $(ORG_ID)
  VERCEL_TOKEN: $(Token)

stages:
  # - stage: Linting
  #   jobs:
  #     - job: linting
  #       displayName: â¬£ ESLint
  #       pool:
  #         vmImage: 'ubuntu-latest'
  #       steps:
  #         - checkout: self
  #           displayName: â¬‡ï¸ Checkout repo

  #         - task: NodeTool@0
  #           inputs:
  #             versionSource: 'spec'
  #             versionSpec: '16.x'

  #         - script: npm install
  #           displayName: ğŸ“¥ Download deps

  #         - script: yarn lint:strict
  #           displayName: ğŸ”¬ Lint

  #     - job: TSChecking
  #       displayName: Ê¦ TypeScript
  #       pool:
  #         vmImage: 'ubuntu-latest'
  #       steps:
  #         - checkout: self
  #           displayName: â¬‡ï¸ Checkout repo

  #         - task: NodeTool@0
  #           inputs:
  #             versionSource: 'spec'
  #             versionSpec: '16.x'

  #         - script: npm install
  #           displayName: ğŸ“¥ Download deps

  #         - script: yarn typecheck
  #           displayName: ğŸ” Type check

  #     - job: Prettier
  #       displayName: ğŸ’… Prettier
  #       pool:
  #         vmImage: 'ubuntu-latest'

  #       steps:
  #         - checkout: self
  #           displayName: â¬‡ï¸ Checkout repo

  #         - task: NodeTool@0
  #           inputs:
  #             versionSource: 'spec'
  #             versionSpec: '16.x'

  #         - script: npm install
  #           displayName: ğŸ“¥ Download deps

  #         - script: yarn format:check
  #           displayName: ğŸ” Type check

  - stage: Test
    jobs:
      - job: Test
        displayName: ğŸƒ Testing
        pool:
          vmImage: 'ubuntu-latest'
        steps:
          - checkout: self
            displayName: â¬‡ï¸ Checkout repo

          - task: NodeTool@0
            inputs:
              versionSource: 'spec'
              versionSpec: '16.x'

          - script: npm install
            displayName: ğŸ“¥ Download deps

          - script: yarn test
            displayName: ğŸƒ Run jest

  - stage: Deploy
    dependsOn: Test
    displayName: â¬£ Deploy to production

    jobs:
      - job: Deploy
        displayName: â¬£ Deploy to production
        pool:
          vmImage: 'ubuntu-latest'
        steps:
          - checkout: self
            displayName: â¬‡ï¸ Checkout repo

          - script: npm install --global vercel@latest
            displayName: â” Setup node/Vercel

          - script: vercel pull --yes --environment=production --token=$(VERCEL_TOKEN)
            displayName: ğŸ“¥ Pull Vercel Environment Information

          - script: vercel build --prod --token=$(VERCEL_TOKEN)
            displayName: ğŸ”¬ Build Project Artifacts

          - script: vercel deploy --prebuilt --prod --token=$(VERCEL_TOKEN)
            displayName: ğŸƒ Deploy Project to Vercel
